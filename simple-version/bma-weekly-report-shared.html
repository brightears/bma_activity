<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMAsia Report</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #FF6B35;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        h2 {
            color: #FF6B35;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .sales-item, .activity-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 100px 80px 1fr 100px 150px 80px 150px 50px;
            gap: 10px;
            align-items: center;
        }
        
        .activity-row {
            display: grid;
            grid-template-columns: 100px 1fr 150px 50px;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn-primary {
            background: #FF6B35;
            color: white;
        }
        
        .btn-primary:hover {
            background: #E55A2B;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-add {
            background: #28a745;
            color: white;
            margin-top: 10px;
        }
        
        .btn-add:hover {
            background: #218838;
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .btn-remove:hover {
            background: #c82333;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .metric-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #FF6B35;
        }
        
        .metric-label {
            color: #6c757d;
            margin-top: 2px;
            font-size: 0.85em;
        }
        
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .sync-status.saving {
            background: #ffc107;
            color: #000;
        }
        
        .sync-status.saved {
            background: #28a745;
            color: white;
        }
        
        .sync-status.error {
            background: #dc3545;
            color: white;
        }
        
        .last-updated {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            text-align: right;
        }
        
        #report-output {
            margin-top: 40px;
            padding: 30px;
            background: white;
            border: 2px solid #FF6B35;
            border-radius: 10px;
            display: none;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .report-header h1 {
            color: #FF6B35;
            font-size: 24px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .item-row {
                grid-template-columns: 1fr;
            }
            
            .activity-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                padding: 20px;
            }
            
            .form-section,
            .action-buttons,
            .sync-status,
            .btn {
                display: none !important;
            }
            
            #report-output {
                display: block !important;
                border: none;
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BMAsia Report</h1>
        <p class="subtitle">Weekly Activity Report System</p>
        
        <form id="report-form">
            <!-- Week and Date Selection -->
            <div class="form-section">
                <h2>Report Period</h2>
                <div class="input-group">
                    <label for="week">Week</label>
                    <input type="number" id="week" name="week" min="1" max="53" required>
                </div>
                <div class="input-group">
                    <label for="year">Year</label>
                    <input type="number" id="year" name="year" min="2024" max="2030" required>
                </div>
                <div class="last-updated" id="last-updated"></div>
            </div>

            <!-- Sales Activities -->
            <div class="form-section">
                <h2>Sales Activities</h2>
                <div id="sales-items">
                    <!-- Sales items will be dynamically added here -->
                </div>
                <button type="button" class="btn btn-add" onclick="addSalesItem()">+ Add Sales Item</button>
                
                <div class="metrics">
                    <div class="metric-card">
                        <div class="metric-value" id="total-yearly">$0</div>
                        <div class="metric-label">Total Yearly</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="total-mrr">$0</div>
                        <div class="metric-label">Total MRR</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="int-yearly">$0</div>
                        <div class="metric-label">INT Yearly (USD)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="th-yearly">฿0</div>
                        <div class="metric-label">TH Yearly (THB)</div>
                    </div>
                </div>
            </div>

            <!-- Sales Activities -->
            <div class="form-section">
                <h2>Sales Activities</h2>
                <div id="sales-activities">
                    <!-- Sales activities will be dynamically added here -->
                </div>
                <button type="button" class="btn btn-add" onclick="addSalesActivity()">+ Add Sales Activity</button>
            </div>

            <!-- Music Design Deliverables -->
            <div class="form-section">
                <h2>Music Design Deliverables</h2>
                <div id="music-items">
                    <!-- Music items will be dynamically added here -->
                </div>
                <button type="button" class="btn btn-add" onclick="addMusicItem()">+ Add Music Item</button>
            </div>

            <!-- Tech/Ops Activities -->
            <div class="form-section">
                <h2>Tech/Ops Activities</h2>
                <div id="tech-items">
                    <!-- Tech items will be dynamically added here -->
                </div>
                <button type="button" class="btn btn-add" onclick="addTechItem()">+ Add Tech Item</button>
            </div>

            <!-- Challenges & Solutions -->
            <div class="form-section">
                <h2>Challenges</h2>
                <div class="input-group">
                    <textarea id="challenges" name="challenges" placeholder="List any challenges faced this week..."></textarea>
                </div>
            </div>

            <!-- Priorities for Next Week -->
            <div class="form-section">
                <h2>Priorities for Next Week</h2>
                <div class="input-group">
                    <textarea id="priorities" name="priorities" placeholder="List priorities for next week..."></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                <button type="button" class="btn btn-secondary" onclick="saveDraft()">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="loadWeekData()">Refresh Data</button>
            </div>
        </form>

        <!-- Report Output -->
        <div id="report-output"></div>
    </div>

    <!-- Sync Status Indicator -->
    <div id="sync-status" class="sync-status" style="display: none;"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://kkhxkfdmmkhhykzljqzl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtraHhrZmRtbWtoaHlremxqcXpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0OTA0MzksImV4cCI6MjA2ODA2NjQzOX0.H20K31RXztvPn8wREpIthNwnNEDX5hlW1x6TsTHtTTw';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Current report ID
        let currentReportId = null;
        let autoSaveTimer = null;
        let lastSavedData = null;
        
        // Initialize the form
        function initializeDate() {
            const now = new Date();
            const week = getWeekNumber(now);
            const year = now.getFullYear();
            
            document.getElementById('week').value = week;
            document.getElementById('year').value = year;
        }
        
        // Get week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        
        // Show sync status
        function showSyncStatus(message, type = 'saving') {
            const status = document.getElementById('sync-status');
            status.textContent = message;
            status.className = `sync-status ${type}`;
            status.style.display = 'block';
            
            if (type === 'saved') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
        
        // Format date to YYYY-MM-DD
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Get today's date formatted
        function getTodayDate() {
            return formatDate(new Date());
        }
        
        // Add Sales Item
        function addSalesItem(data = {}) {
            const container = document.getElementById('sales-items');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'sales-item';
            
            itemDiv.innerHTML = `
                <div class="item-row">
                    <input type="date" class="sales-date" value="${data.date || getTodayDate()}" onchange="autoSave()">
                    <select class="sales-status" onchange="autoSave()">
                        <option value="New" ${data.status === 'New' ? 'selected' : ''}>New</option>
                        <option value="Existing" ${data.status === 'Existing' ? 'selected' : ''}>Existing</option>
                        <option value="Renewal" ${data.status === 'Renewal' ? 'selected' : ''}>Renewal</option>
                    </select>
                    <input type="text" class="sales-description" placeholder="Deal/Company" value="${data.description || ''}" onchange="autoSave()">
                    <select class="sales-region" onchange="calculateMetrics(); autoSave()">
                        <option value="INT" ${data.region === 'INT' ? 'selected' : ''}>INT</option>
                        <option value="TH" ${data.region === 'TH' ? 'selected' : ''}>TH</option>
                    </select>
                    <input type="number" class="sales-value" placeholder="Yearly Value" value="${data.yearly_value || ''}" onchange="calculateMetrics(); autoSave()">
                    <input type="text" class="sales-zones" placeholder="Zones" value="${data.zones || ''}" onchange="autoSave()">
                    <input type="text" class="sales-member" placeholder="Team Member" value="${data.team_member || ''}" onchange="autoSave()">
                    <button type="button" class="btn btn-remove" onclick="removeSalesItem(this)">X</button>
                </div>
            `;
            
            container.appendChild(itemDiv);
            calculateMetrics();
        }
        
        // Remove Sales Item
        function removeSalesItem(button) {
            button.closest('.sales-item').remove();
            calculateMetrics();
            autoSave();
        }
        
        // Add Sales Activity
        function addSalesActivity(data = {}) {
            const container = document.getElementById('sales-activities');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'activity-item';
            
            itemDiv.innerHTML = `
                <div class="activity-row">
                    <input type="date" class="activity-date" value="${data.date || getTodayDate()}" onchange="autoSave()">
                    <input type="text" class="activity-description" placeholder="Sales activity description" value="${data.description || ''}" onchange="autoSave()">
                    <input type="text" class="activity-member" placeholder="Team Member" value="${data.team_member || ''}" onchange="autoSave()">
                    <button type="button" class="btn btn-remove" onclick="removeSalesActivity(this)">X</button>
                </div>
            `;
            
            container.appendChild(itemDiv);
        }
        
        // Remove Sales Activity
        function removeSalesActivity(button) {
            button.closest('.activity-item').remove();
            autoSave();
        }
        
        // Add Music Item
        function addMusicItem(data = {}) {
            const container = document.getElementById('music-items');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'activity-item';
            
            itemDiv.innerHTML = `
                <div class="activity-row">
                    <input type="date" class="activity-date" value="${data.date || getTodayDate()}" onchange="autoSave()">
                    <input type="text" class="activity-description" placeholder="Music deliverable description" value="${data.description || ''}" onchange="autoSave()">
                    <input type="text" class="activity-member" placeholder="Team Member" value="${data.team_member || ''}" onchange="autoSave()">
                    <button type="button" class="btn btn-remove" onclick="removeMusicItem(this)">X</button>
                </div>
            `;
            
            container.appendChild(itemDiv);
        }
        
        // Remove Music Item
        function removeMusicItem(button) {
            button.closest('.activity-item').remove();
            autoSave();
        }
        
        // Add Tech Item
        function addTechItem(data = {}) {
            const container = document.getElementById('tech-items');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'activity-item';
            
            itemDiv.innerHTML = `
                <div class="activity-row">
                    <input type="date" class="activity-date" value="${data.date || getTodayDate()}" onchange="autoSave()">
                    <input type="text" class="activity-description" placeholder="Tech/Ops activity description" value="${data.description || ''}" onchange="autoSave()">
                    <input type="text" class="activity-member" placeholder="Team Member" value="${data.team_member || ''}" onchange="autoSave()">
                    <button type="button" class="btn btn-remove" onclick="removeTechItem(this)">X</button>
                </div>
            `;
            
            container.appendChild(itemDiv);
        }
        
        // Remove Tech Item
        function removeTechItem(button) {
            button.closest('.activity-item').remove();
            autoSave();
        }
        
        // Calculate metrics
        function calculateMetrics() {
            const salesItems = document.querySelectorAll('.sales-item');
            let totalYearly = 0;
            let intYearly = 0;
            let thYearly = 0;
            
            salesItems.forEach(item => {
                const value = parseFloat(item.querySelector('.sales-value').value) || 0;
                const region = item.querySelector('.sales-region').value;
                
                totalYearly += value;
                if (region === 'INT') {
                    intYearly += value;
                } else {
                    thYearly += value;
                }
            });
            
            const totalMRR = totalYearly / 12;
            
            document.getElementById('total-yearly').textContent = `$${totalYearly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('total-mrr').textContent = `$${totalMRR.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('int-yearly').textContent = `$${intYearly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('th-yearly').textContent = `฿${thYearly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        // Collect form data
        function collectFormData() {
            const salesItems = [];
            document.querySelectorAll('.sales-item').forEach(item => {
                salesItems.push({
                    date: item.querySelector('.sales-date').value,
                    status: item.querySelector('.sales-status').value,
                    description: item.querySelector('.sales-description').value,
                    region: item.querySelector('.sales-region').value,
                    yearly_value: parseFloat(item.querySelector('.sales-value').value) || 0,
                    zones: item.querySelector('.sales-zones').value,
                    team_member: item.querySelector('.sales-member').value
                });
            });
            
            const salesActivities = [];
            document.querySelectorAll('#sales-activities .activity-item').forEach(item => {
                salesActivities.push({
                    date: item.querySelector('.activity-date').value,
                    description: item.querySelector('.activity-description').value,
                    team_member: item.querySelector('.activity-member').value
                });
            });
            
            const musicItems = [];
            document.querySelectorAll('#music-items .activity-item').forEach(item => {
                musicItems.push({
                    date: item.querySelector('.activity-date').value,
                    description: item.querySelector('.activity-description').value,
                    team_member: item.querySelector('.activity-member').value
                });
            });
            
            const techItems = [];
            document.querySelectorAll('#tech-items .activity-item').forEach(item => {
                techItems.push({
                    date: item.querySelector('.activity-date').value,
                    description: item.querySelector('.activity-description').value,
                    team_member: item.querySelector('.activity-member').value
                });
            });
            
            return {
                week_number: parseInt(document.getElementById('week').value),
                year: parseInt(document.getElementById('year').value),
                sales_items: salesItems,
                sales_activities: salesActivities,
                music_items: musicItems,
                tech_items: techItems,
                challenges: document.getElementById('challenges').value.split('\n').filter(c => c.trim()),
                priorities: document.getElementById('priorities').value.split('\n').filter(p => p.trim())
            };
        }
        
        // Load data for the current week
        async function loadWeekData() {
            const week = parseInt(document.getElementById('week').value);
            const year = parseInt(document.getElementById('year').value);
            
            if (!week || !year) return;
            
            showSyncStatus('Loading data...', 'saving');
            
            try {
                // First check if a report exists for this week
                const { data: reports, error: reportError } = await supabase
                    .from('reports')
                    .select('id')
                    .eq('week_number', week)
                    .eq('year', year)
                    .limit(1);
                
                if (reportError) throw reportError;
                
                if (reports && reports.length > 0) {
                    currentReportId = reports[0].id;
                    
                    // Load all data for this report
                    const [salesResult, musicResult, techResult, challengesResult, prioritiesResult] = await Promise.all([
                        supabase.from('sales_items').select('*').eq('report_id', currentReportId),
                        supabase.from('music_items').select('*').eq('report_id', currentReportId),
                        supabase.from('tech_items').select('*').eq('report_id', currentReportId),
                        supabase.from('challenges').select('*').eq('report_id', currentReportId),
                        supabase.from('priorities').select('*').eq('report_id', currentReportId)
                    ]);
                    
                    // Clear existing items
                    document.getElementById('sales-items').innerHTML = '';
                    document.getElementById('sales-activities').innerHTML = '';
                    document.getElementById('music-items').innerHTML = '';
                    document.getElementById('tech-items').innerHTML = '';
                    
                    // Load sales items
                    if (salesResult.data) {
                        salesResult.data.forEach(item => addSalesItem(item));
                    }
                    
                    // Load sales activities from localStorage (temporary solution)
                    const savedActivities = localStorage.getItem(`sales-activities-${week}-${year}`);
                    if (savedActivities) {
                        const activities = JSON.parse(savedActivities);
                        activities.forEach(item => addSalesActivity(item));
                    }
                    
                    // Load music items
                    if (musicResult.data) {
                        musicResult.data.forEach(item => addMusicItem(item));
                    }
                    
                    // Load tech items
                    if (techResult.data) {
                        techResult.data.forEach(item => addTechItem(item));
                    }
                    
                    // Load challenges and priorities
                    document.getElementById('challenges').value = challengesResult.data ? 
                        challengesResult.data.map(c => c.description).join('\n') : '';
                    document.getElementById('priorities').value = prioritiesResult.data ? 
                        prioritiesResult.data.map(p => p.description).join('\n') : '';
                    
                    // Update last updated time
                    const { data: reportData } = await supabase
                        .from('reports')
                        .select('updated_at')
                        .eq('id', currentReportId)
                        .single();
                    
                    if (reportData) {
                        const date = new Date(reportData.updated_at);
                        document.getElementById('last-updated').textContent = 
                            `Last updated: ${date.toLocaleString()}`;
                    }
                } else {
                    // No report exists, clear the form
                    currentReportId = null;
                    document.getElementById('sales-items').innerHTML = '';
                    document.getElementById('sales-activities').innerHTML = '';
                    document.getElementById('music-items').innerHTML = '';
                    document.getElementById('tech-items').innerHTML = '';
                    document.getElementById('challenges').value = '';
                    document.getElementById('priorities').value = '';
                    document.getElementById('last-updated').textContent = '';
                    
                    // Add one empty row for each section
                    addSalesItem();
                    addSalesActivity();
                    addMusicItem();
                    addTechItem();
                }
                
                calculateMetrics();
                showSyncStatus('Data loaded', 'saved');
                
                // Store current data for comparison
                lastSavedData = JSON.stringify(collectFormData());
                
            } catch (error) {
                console.error('Error loading data:', error);
                showSyncStatus('Error loading data', 'error');
            }
        }
        
        // Save draft to Supabase
        async function saveDraft() {
            showSyncStatus('Saving...', 'saving');
            
            try {
                const formData = collectFormData();
                
                // Check if data has changed
                const currentData = JSON.stringify(formData);
                if (currentData === lastSavedData) {
                    showSyncStatus('No changes to save', 'saved');
                    return;
                }
                
                // Create or get report
                if (!currentReportId) {
                    const { data: newReport, error: createError } = await supabase
                        .from('reports')
                        .insert({
                            week_number: formData.week_number,
                            year: formData.year,
                            created_by: '00000000-0000-0000-0000-000000000000' // Default user ID
                        })
                        .select()
                        .single();
                    
                    if (createError) throw createError;
                    currentReportId = newReport.id;
                }
                
                // Delete existing items
                await Promise.all([
                    supabase.from('sales_items').delete().eq('report_id', currentReportId),
                    supabase.from('music_items').delete().eq('report_id', currentReportId),
                    supabase.from('tech_items').delete().eq('report_id', currentReportId),
                    supabase.from('challenges').delete().eq('report_id', currentReportId),
                    supabase.from('priorities').delete().eq('report_id', currentReportId)
                ]);
                
                // Insert new items
                const insertPromises = [];
                
                if (formData.sales_items.length > 0) {
                    const salesData = formData.sales_items.map(item => ({
                        ...item,
                        report_id: currentReportId
                    }));
                    insertPromises.push(supabase.from('sales_items').insert(salesData));
                }
                
                if (formData.music_items.length > 0) {
                    const musicData = formData.music_items.map(item => ({
                        ...item,
                        report_id: currentReportId
                    }));
                    insertPromises.push(supabase.from('music_items').insert(musicData));
                }
                
                if (formData.tech_items.length > 0) {
                    const techData = formData.tech_items.map(item => ({
                        ...item,
                        report_id: currentReportId
                    }));
                    insertPromises.push(supabase.from('tech_items').insert(techData));
                }
                
                if (formData.challenges.length > 0) {
                    const challengesData = formData.challenges.map(desc => ({
                        description: desc,
                        report_id: currentReportId
                    }));
                    insertPromises.push(supabase.from('challenges').insert(challengesData));
                }
                
                if (formData.priorities.length > 0) {
                    const prioritiesData = formData.priorities.map(desc => ({
                        description: desc,
                        report_id: currentReportId
                    }));
                    insertPromises.push(supabase.from('priorities').insert(prioritiesData));
                }
                
                await Promise.all(insertPromises);
                
                // Save sales activities to localStorage (temporary)
                if (formData.sales_activities.length > 0) {
                    localStorage.setItem(
                        `sales-activities-${formData.week_number}-${formData.year}`,
                        JSON.stringify(formData.sales_activities)
                    );
                }
                
                // Update the report's updated_at timestamp
                await supabase
                    .from('reports')
                    .update({ updated_at: new Date().toISOString() })
                    .eq('id', currentReportId);
                
                lastSavedData = currentData;
                document.getElementById('last-updated').textContent = 
                    `Last updated: ${new Date().toLocaleString()}`;
                
                showSyncStatus('Saved successfully', 'saved');
                
            } catch (error) {
                console.error('Error saving:', error);
                showSyncStatus('Error saving data', 'error');
            }
        }
        
        // Auto-save function
        function autoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveDraft();
            }, 2000); // Save 2 seconds after user stops typing
        }
        
        // Generate report
        function generateReport() {
            const data = collectFormData();
            
            // Calculate metrics
            let totalYearly = 0;
            let intYearly = 0;
            let thYearly = 0;
            
            data.sales_items.forEach(item => {
                totalYearly += item.yearly_value;
                if (item.region === 'INT') {
                    intYearly += item.yearly_value;
                } else {
                    thYearly += item.yearly_value;
                }
            });
            
            const totalMRR = totalYearly / 12;
            const intMRR = intYearly / 12;
            const thMRR = thYearly / 12;
            
            // Generate HTML report
            let reportHTML = `
                <div class="report-header">
                    <h1>BMAsia Activity Report</h1>
                    <h2>Week ${data.week_number} - ${data.year}</h2>
                    <p style="color: #666; margin-top: 10px;">Generated on ${new Date().toLocaleDateString()}</p>
                </div>
            `;
            
            // Sales Activities
            if (data.sales_items.length > 0) {
                reportHTML += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #FF6B35; margin-bottom: 15px;">Sales Activities</h3>
                `;
                
                data.sales_items.forEach(item => {
                    if (item.description) {
                        reportHTML += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                                <strong>${item.date}</strong> - 
                                <span style="color: #28a745;">${item.status}</span> - 
                                ${item.description}
                                ${item.zones ? ` (Zones: ${item.zones})` : ''}
                                ${item.region ? ` [${item.region}]` : ''}
                                ${item.yearly_value ? ` - $${item.yearly_value.toLocaleString()}/year` : ''}
                                ${item.team_member ? ` - ${item.team_member}` : ''}
                            </div>
                        `;
                    }
                });
                
                reportHTML += `
                    <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
                        <strong>Metrics Summary:</strong><br>
                        Total Yearly Value: $${totalYearly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>
                        Total MRR: $${totalMRR.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br>
                        International: $${intYearly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} 
                        (MRR: $${intMRR.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})<br>
                        Thailand: ฿${thYearly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} 
                        (MRR: ฿${thMRR.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})
                    </div>
                    </div>
                `;
            }
            
            // Sales Activities
            if (data.sales_activities && data.sales_activities.length > 0) {
                reportHTML += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #FF6B35; margin-bottom: 15px;">Sales Activities</h3>
                `;
                
                data.sales_activities.forEach(item => {
                    if (item.description) {
                        reportHTML += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                                <strong>${item.date}</strong> - 
                                ${item.description}
                                ${item.team_member ? ` - ${item.team_member}` : ''}
                            </div>
                        `;
                    }
                });
                
                reportHTML += `</div>`;
            }
            
            // Music Design Deliverables
            if (data.music_items.length > 0) {
                reportHTML += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #FF6B35; margin-bottom: 15px;">Music Design Deliverables</h3>
                `;
                
                data.music_items.forEach(item => {
                    if (item.description) {
                        reportHTML += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                                <strong>${item.date}</strong> - 
                                ${item.description}
                                ${item.team_member ? ` - ${item.team_member}` : ''}
                            </div>
                        `;
                    }
                });
                
                reportHTML += `</div>`;
            }
            
            // Tech/Ops Activities
            if (data.tech_items.length > 0) {
                reportHTML += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #FF6B35; margin-bottom: 15px;">Tech/Ops Activities</h3>
                `;
                
                data.tech_items.forEach(item => {
                    if (item.description) {
                        reportHTML += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                                <strong>${item.date}</strong> - 
                                ${item.description}
                                ${item.team_member ? ` - ${item.team_member}` : ''}
                            </div>
                        `;
                    }
                });
                
                reportHTML += `</div>`;
            }
            
            // Challenges
            if (data.challenges.length > 0 && data.challenges[0]) {
                reportHTML += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #FF6B35; margin-bottom: 15px;">Challenges</h3>
                        <ul style="margin-left: 20px;">
                `;
                
                data.challenges.forEach(challenge => {
                    if (challenge) {
                        reportHTML += `<li style="margin-bottom: 5px;">${challenge}</li>`;
                    }
                });
                
                reportHTML += `</ul></div>`;
            }
            
            // Priorities
            if (data.priorities.length > 0 && data.priorities[0]) {
                reportHTML += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #FF6B35; margin-bottom: 15px;">Priorities for Next Week</h3>
                        <ul style="margin-left: 20px;">
                `;
                
                data.priorities.forEach(priority => {
                    if (priority) {
                        reportHTML += `<li style="margin-bottom: 5px;">${priority}</li>`;
                    }
                });
                
                reportHTML += `</ul></div>`;
            }
            
            // Add print button
            reportHTML += `
                <div style="margin-top: 30px; text-align: center;" class="no-print">
                    <button onclick="window.print()" class="btn btn-primary">Print / Save as PDF</button>
                </div>
            `;
            
            // Display report
            const reportOutput = document.getElementById('report-output');
            reportOutput.innerHTML = reportHTML;
            reportOutput.style.display = 'block';
            
            // Scroll to report
            reportOutput.scrollIntoView({ behavior: 'smooth' });
            
            // Save before generating report
            saveDraft();
        }
        
        // Poll for updates from other users
        async function pollForUpdates() {
            if (!currentReportId) return;
            
            try {
                const { data: reportData } = await supabase
                    .from('reports')
                    .select('updated_at')
                    .eq('id', currentReportId)
                    .single();
                
                if (reportData) {
                    const lastUpdated = document.getElementById('last-updated').textContent;
                    const newDate = new Date(reportData.updated_at).toLocaleString();
                    
                    if (lastUpdated && !lastUpdated.includes(newDate)) {
                        // Data has been updated by someone else
                        if (confirm('The report has been updated by another user. Do you want to reload?')) {
                            loadWeekData();
                        }
                    }
                }
            } catch (error) {
                console.error('Error polling for updates:', error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeDate();
            loadWeekData();
            
            // Load data when week/year changes
            document.getElementById('week').addEventListener('change', loadWeekData);
            document.getElementById('year').addEventListener('change', loadWeekData);
            
            // Poll for updates every 30 seconds
            setInterval(pollForUpdates, 30000);
        });
    </script>
</body>
</html>